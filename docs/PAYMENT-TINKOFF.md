# Оплата Tinkoff Internet Acquiring

## Архитектура

- **Корзина** (CartContext + localStorage): товары и количество на клиенте.
- **Оформление**: пользователь заполняет контакты/доставку в форме (CheckoutFormModal на странице корзины и в боковой панели).
- **Кнопка «Оплатить»**:
  1. Валидация: корзина не пустая, обязательные поля формы заполнены.
  2. `POST /api/orders` — создание заказа на сервере. **Сумма пересчитывается по каталогу** (клиент не передаёт amount).
  3. `POST /api/payments/tinkoff/init` — инициализация платежа в Tinkoff по `orderId`, получение `paymentUrl`.
  4. Редирект пользователя на `paymentUrl` (страница оплаты Tinkoff).
- **После оплаты**: Tinkoff редиректит на Success/Fail URL и шлёт уведомление на `NotificationURL`.
- **Вебхук** в кабинете T-Bank настраивается на `https://theame.ru/api/tinkoff-callback`. Роут `POST /api/tinkoff-callback`: логирование входящих данных, проверка подписи, обновление статуса заказа (paid / failed / canceled). Данные заказа сохраняются в структуре, готовой для отправки в Telegram (пока только лог). Дублирующий роут `POST /api/payments/tinkoff/notification` оставлен для совместимости.
- **Страницы результата**:
  - `/payment/success?orderId=...` — показ заказа, при статусе `payment_pending` — polling до 20 с; при `paid` — очистка корзины.
  - `/payment/fail?orderId=...` — «Оплата не прошла», кнопка «Попробовать снова» (повторный init для того же заказа).

## Переменные окружения

Скопируйте `.env.example` в `.env.local` и заполните. **Секреты только в `.env.local`**, в репозиторий не коммитить.

| Переменная | Описание |
|------------|----------|
| `TINKOFF_TERMINAL_KEY` | Ключ терминала (тест/боевой — разные значения) |
| `TINKOFF_PASSWORD` | Пароль терминала |
| `TINKOFF_SUCCESS_URL` | URL редиректа при успехе (например `https://yoursite.com/payment/success`) |
| `TINKOFF_FAIL_URL` | URL редиректа при ошибке |
| `TINKOFF_NOTIFICATION_URL` | URL вебхука (HTTPS; для локалки — ngrok и т.п.) |
| `NEXT_PUBLIC_SITE_URL` | Базовый URL сайта (если не заданы Success/Fail URL) |

Переключение тест → боевой: подставьте боевые `TINKOFF_TERMINAL_KEY` и `TINKOFF_PASSWORD` в `.env.local` (без изменений в коде).

## Запуск

1. Установить зависимости: `npm install`.
2. Создать таблицу заказов в Supabase: выполнить `scripts/orders-table.sql` в SQL Editor.
3. Если появилась ошибка **«Could not find the 'amount' column of 'orders' in the schema cache»** — выполнить миграцию `scripts/orders-add-columns.sql` в SQL Editor, затем **перезагрузить схему PostgREST**:
   - в SQL Editor: `SELECT pg_notify('pgrst', 'reload schema');`
   - или в Dashboard: Settings → API → перезапуск/обновление проекта.
4. Добавить в `.env.local` переменные из `.env.example` (Supabase уже есть; добавить Tinkoff и при необходимости NotificationURL).
5. Запуск: `npm run dev`.

## Сценарий теста

1. Добавить товары в корзину.
2. Открыть корзину (иконка корзины в шапке — модалка).
3. Заполнить обязательные поля: имя, телефон, согласие с офертой, доставка/самовывоз и т.д.
4. Нажать «ПЕРЕЙТИ К ОПЛАТЕ».
5. Должен создаться заказ и произойти редирект на страницу оплаты Tinkoff (тестовый терминал).
6. На тестовом терминале завершить оплату (успех или отмена).
7. Редирект на `/payment/success` или `/payment/fail`; на success при статусе `paid` корзина очищается.

Для проверки вебхука локально: поднять туннель (ngrok), подставить `TINKOFF_NOTIFICATION_URL=https://xxx.ngrok.io/api/tinkoff-callback` в `.env.local`.

## Чеклист «как проверить, что работает»

- [ ] Корзина не пустая + форма валидна → кнопка «Оплатить» активна.
- [ ] После «Оплатить» создаётся заказ (проверить в Supabase таблицу `orders`), сумма совпадает с пересчётом по каталогу.
- [ ] Редирект на страницу оплаты Tinkoff (тестовый терминал).
- [ ] После успешной оплаты — редирект на `/payment/success`, отображается состав заказа и итог, корзина очищается (после получения статуса `paid`, при необходимости после polling).
- [ ] После неуспешной оплаты — редирект на `/payment/fail`, кнопка «Попробовать снова» снова ведёт на оплату.
- [ ] Вебхук: при смене статуса в Tinkoff приходит POST на NotificationURL, статус заказа в БД обновляется (paid/failed/canceled).
- [ ] Секреты (TerminalKey, Password) не в коде и не в логах; только в `.env.local`.

# Обновление админки товаров: режим "Варианты"

## Дата: 2026-02-01

---

## Часть A: Изменение порядка полей (выполнено)

В модалке "Новый товар" для обоих типов товаров (Обычный и Варианты):

**Новый порядок полей:**
1. Тип товара (radio)
2. Название
3. Описание
4. *(далее зависит от типа)*
5. **Цена** ← перемещена выше
6. **Категории** ← теперь после цены
7. Статусы (Скрыть с витрины / Предзаказ)
8. Кнопки (Создать / Отмена)

---

## Часть B: Режим "Варианты" (реализовано)

### B1) UI блок "Варианты"

**Добавлена кнопка "Добавить вариант"** под полем "Описание".

**Каждый вариант** — карточка с:
- **Название варианта** (редактируемое, по умолчанию "Вариант 1", "Вариант 2", и т.д.)
- **Состав и размер** (textarea)
- **Цена** (input без стрелочек, блокируется если включен Предзаказ)
- **Предзаказ** (toggle внутри варианта) — если включен, цена скрывается на витрине
- **Фото варианта** (1 фото, загрузка с компьютера, превью квадратом, удаление)

**Функции:**
- Добавление неограниченного количества вариантов
- Удаление варианта
- Drag & Drop для изменения порядка вариантов
- Переименование вариантов
- Порядок сохраняется через `sort_order`

### B2) Общее главное фото товара

В режиме "Варианты" добавлен блок **"Главное фото товара"**:
- Загрузка 1 файла
- Превью квадратом (32x32)
- Удаление/замена до сохранения
- Используется как главное фото товара на витрине

### B3) Сохранение данных (Supabase)

**Валидация при создании (режим "Варианты"):**
- Тип = варианты
- Название (обязательно)
- Описание (обязательно)
- Главное фото товара (обязательно)
- Минимум 1 категория
- Минимум 1 вариант

**Валидация каждого варианта:**
- Название варианта (не пустое)
- Состав и размер (не пустое)
- Цена > 0, если предзаказ выключен (если предзаказ включен — цена может быть 0)
- Фото варианта (необязательно)

**Статусы:**
- "Скрыть с витрины" — общий (вне вариантов)
- "Предзаказ" — только внутри варианта

**Логика создания (без частично созданных сущностей):**
1. Загружаются все изображения (главное + фото вариантов) в Storage
2. Создаётся `variant_products` с вычисленным `min_price_cache` (минимальная цена среди активных не-предзаказов)
3. Создаются все `product_variants` для данного `variant_products`
4. При ошибке на любом этапе — транзакция откатывается (частично созданных товаров не будет)

---

## Изменения в базе данных

### Новые миграции:

1. **`scripts/migrations/product-variants-add-fields.sql`**
   - Добавляет `composition` TEXT (состав и размер) в `product_variants`
   - Добавляет `is_preorder` BOOLEAN в `product_variants`
   - Добавляет `name` TEXT в `product_variants` (если отсутствует)

2. **`scripts/migrations/variant-products-add-category-slugs.sql`**
   - Добавляет `category_slugs` TEXT[] в `variant_products` (привязка к нескольким категориям)

### Обновлённая схема:

**`variant_products`** (родительский товар с вариантами):
- `id` (INT, PK)
- `name`, `slug`, `description`
- `image_url` (главное фото товара)
- `min_price_cache` (минимальная цена вариантов, вычисляется автоматически)
- `is_active`, `is_hidden`, `sort_order`
- `category_slug`, `category_slugs` ← добавлено

**`product_variants`** (варианты товара):
- `id` (INT, PK)
- `product_id` → `variant_products.id` (FK)
- `name` ← добавлено (название варианта)
- `composition` ← добавлено (состав и размер)
- `price` (цена варианта)
- `is_preorder` ← добавлено (предзаказ для варианта)
- `image_url` (фото варианта)
- `sort_order`, `is_active`

---

## Изменённые файлы

| Файл | Изменения |
|------|-----------|
| `src/app/admin/products/page.tsx` | — Включён radio "Варианты"<br>— Переупорядочены поля (Цена перед Категориями)<br>— Добавлен UI для вариантов (список, drag&drop, редактирование)<br>— Добавлено главное фото для вариантного товара<br>— Обновлена валидация<br>— Обновлена логика создания (загрузка фото, создание variant_products + product_variants) |
| `src/app/api/admin/products/route.ts` | — Обновлена схема `createVariantSchema` (добавлены `category_slugs`, `variants`)<br>— Логика POST для type="variant": создаётся `variant_products` + массив `product_variants`<br>— Вычисление `min_price_cache` |
| `scripts/migrations/product-variants-add-fields.sql` | Новая миграция |
| `scripts/migrations/variant-products-add-category-slugs.sql` | Новая миграция |
| `docs/PRODUCT-VARIANTS-UPDATE.md` | Этот документ |

---

## Проверка RLS/Policies

**Требуется проверить в Supabase Dashboard:**

1. **Storage bucket `product-images`**:
   - Существует и публичный
   - RLS policy для INSERT от `auth.role() = 'service_role'`

2. **Таблицы:**
   - `variant_products`: INSERT/UPDATE от service_role (админка использует `getSupabaseAdmin()`)
   - `product_variants`: INSERT/UPDATE от service_role
   - При использовании service_role RLS обычно не применяется — проверить что вставки проходят

---

## Запуск миграций

Выполнить в Supabase SQL Editor:

1. `scripts/migrations/product-variants-add-fields.sql`
2. `scripts/migrations/variant-products-add-category-slugs.sql`

---

## Итого

✅ **Часть A** (переупорядочивание полей): Цена теперь перед Категориями для обоих типов  
✅ **Часть B** (режим "Варианты"): Полностью реализован с drag&drop, валидацией, загрузкой фото, и сохранением в БД  
✅ Без новых библиотек (используется существующий drag&drop подход)  
✅ Код простой и понятный, переиспользованы паттерны из простого товара  
✅ Без partially-created товаров (все изображения загружаются перед insert, при ошибке — откат)

**Примечание:** Функционал редактирования вариантных товаров (`/admin/products/[id]`) требует отдельной реализации.

# Аудит раздела «Категории» (админка)

Технический аудит: данные БД, slug, связи с товарами, UI и API.

---

## Запуск аудита

```bash
npm run audit-categories
```

Требуется `.env.local` с `NEXT_PUBLIC_SUPABASE_URL` и `SUPABASE_SERVICE_ROLE_KEY`.

Скрипт:
- проверяет и при необходимости исправляет `name` (trim) и `slug` (slugify(name), уникальность);
- проверяет связи: товары (`products`, `variant_products`) не должны ссылаться на несуществующий `category_slug` / `category_slugs`;
- выводит структурированный отчёт в консоль.

---

## Формат отчёта (консоль)

### Данные
- **Категорий всего** — число записей в таблице `categories`
- **Исправлено slug** — количество записей, у которых slug приведён к slugify(name)
- **Подправлено name (trim)** — количество записей с обрезанными пробелами в name
- **Конфликтов slug (-2,-3)** — сколько раз использованы суффиксы из-за занятого slug

### Изменённые slug
Таблица: `id | name | oldSlug -> newSlug`

### Найденные баги
- Пустой name у категории
- Дубликаты названий (case-insensitive)
- Категория без slug
- Ошибки обновления в БД

### Битые связи
Список товаров/вариантов, у которых `category_slug` или элемент `category_slugs` не найден в таблице `categories`. Не удаляются автоматически — только логирование.

---

## Исправления по результатам аудита

### БД / данные
- Скрипт `audit-categories` при запуске правит некорректные slug и trim name.
- Отдельно можно запустить `npm run fix-category-slugs` только для исправления slug без проверки связей.

### Админка (UI)
- В карточке категории отображаются **name** и **slug** (slug — моноширинным текстом под названием).
- В форме создания/редактирования: проверка пустого названия и пустого slug с явными сообщениями об ошибках.

### API
- **POST /api/admin/categories**: валидация формата slug (только `a-z`, `0-9`, `-`). При неверном формате — 400 с текстом: «Slug может содержать только латинские буквы, цифры и дефис (a-z, 0-9, -).»
- **PATCH /api/admin/categories/[id]**: та же валидация slug при передаче поля `slug`.
- Уникальность slug проверяется на сервере (при создании и при обновлении).

### Фронт
- Хедер «Каталог» берёт категории из `/api/categories` (таблица `categories`, slug из БД).
- Страницы `/magazine/[slug]` используют `getCategories()` и `getCategoryBySlug` — slug из URL должен существовать в БД; иначе 404.
- `generateStaticParams` для magazine строится из `getCategories()`, после исправления slug страницы пересобираются при следующем билде.

---

## Затронутые файлы

| Файл | Изменения |
|------|-----------|
| `src/components/admin/categories/CategoryCard.tsx` | Отображение slug под названием |
| `src/app/admin/categories/page.tsx` | Валидация: название обязательно, сообщения об ошибках |
| `src/app/api/admin/categories/route.ts` | Валидация формата slug, сообщение об ошибке 400 |
| `src/app/api/admin/categories/[id]/route.ts` | Валидация формата slug при PATCH |
| `scripts/audit-categories.ts` | Новый скрипт: аудит, правки name/slug, проверка связей, отчёт |
| `package.json` | Скрипт `audit-categories` |
| `docs/AUDIT-CATEGORIES-REPORT.md` | Этот отчёт |

---

## Ограничения

- Данные не удаляются автоматически.
- Бизнес-логика и дизайн не менялись.
- Новые поля не вводились.
- Битые связи только логируются; привязку к корректной категории или очистку нужно делать вручную (админка товаров или правки в БД).

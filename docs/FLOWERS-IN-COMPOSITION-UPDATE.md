# Обновление фичи "Цветы в составе" (D2 Iteration)

## Выполненные изменения

### 1. Уменьшены кнопки цветов
- **Файл**: `src/components/catalog/flower-filter-buttons.tsx`
- **Изменения**: Кнопки стали компактнее (высота ~32-40px вместо больших)
- **Стили**: `h-8 md:h-9`, `px-3 md:px-4`, `text-sm`, `flex-wrap gap-2`

### 2. Добавлена нормализация ключей цветов
- **Файл**: `src/lib/normalizeFlowerKey.ts`
- **Функция**: `normalizeFlowerKey(name: string): string`
- **Логика**: lowercase, trim, замена ё→е, пробелы→дефисы, удаление двойных дефисов
- **Использование**: В компоненте кнопок и на странице категории для сравнения ключей

### 3. Добавлено поле `flower_sections` в категорию
- **Миграция**: `scripts/migrations/categories-add-flower-sections.sql`
- **Тип**: JSONB в PostgreSQL
- **Структура**: `[{key: string, title: string, description: string}]`
- **Файлы**: 
  - `src/lib/categories.ts` - обновлены типы
  - `src/app/api/admin/categories/route.ts` - добавлена поддержка в API
  - `src/app/api/admin/categories/[id]/route.ts` - добавлена поддержка в API

### 4. Обновлена логика заголовка/описания на странице категории
- **Файл**: `src/app/magazine/[slug]/page.tsx`
- **Логика**: 
  - Если `?flower=` выбран → ищем в `category.flower_sections` по ключу
  - Если найдено → используем `title` и `description` из подраздела
  - Если не найдено → fallback на capitalize названия цветка

### 5. Добавлена секция "Подразделы (цветы)" в админке категорий
- **Файл**: `src/app/admin/categories/page.tsx`
- **UI**: 
  - Показывается только для категории "Цветы в составе" (slug: `cvety-v-sostave`)
  - Кнопка "Добавить цветок" открывает список доступных цветов
  - Для каждого подраздела можно редактировать `title` и `description`
  - Кнопка "Удалить" для удаления подраздела

### 6. Перенесен блок "Цветы в составе" под поле "Состав" в форме товара
- **Файл**: `src/app/admin/products/page.tsx`
- **Изменения**:
  - Блок теперь показывается всегда (не только для категории "Цветы в составе")
  - Расположен сразу под полем "Состав"
  - Добавлена кнопка "Заполнить из состава" для автозаполнения из поля `composition`
  - Сохраняется в `composition_flowers` для всех товаров

## Миграции БД

Выполнить в Supabase SQL Editor:
1. `categories-add-flower-sections.sql` - добавляет поле `flower_sections` (JSONB)

## Использование

### Для администратора

1. **Редактирование категории "Цветы в составе"**:
   - Открыть админку → Категории → Редактировать "Цветы в составе"
   - В секции "Подразделы (цветы)" нажать "Добавить цветок"
   - Выбрать цветок из списка
   - Заполнить заголовок и описание для этого цветка
   - Сохранить категорию

2. **Редактирование товара**:
   - В форме товара найти поле "Состав"
   - Под ним блок "Цветы в составе (фильтр)"
   - Можно отметить цветы вручную или нажать "Заполнить из состава"
   - Сохранить товар

### Для пользователя

1. Перейти в категорию "Цветы в составе"
2. Под списком категорий появятся компактные кнопки цветов
3. Кликнуть на цветок → заголовок и описание страницы изменятся на индивидуальные (если заданы в админке)
4. Товары отфильтруются по выбранному цветку

## Технические детали

- **Нормализация ключей**: Используется `normalizeFlowerKey()` для единообразного сравнения
- **Хранение**: `flower_sections` хранится как JSONB в PostgreSQL
- **Fallback**: Если подраздел не найден, используется capitalize названия цветка
- **Изоляция**: Все изменения работают только в категории "Цветы в составе", не затрагивают "Каталог" и "Все цветы"

# Фича "Цветы в составе"

## Описание

Фича позволяет фильтровать товары по цветам, входящим в состав букета. В категории "Цветы в составе" под списком категорий отображаются квадратные кнопки-фильтры с названиями цветов. При клике на кнопку товары фильтруются по наличию выбранного цветка в составе.

## Компоненты

### 1. Утилита парсинга состава
- **Файл**: `src/lib/parseCompositionFlowers.ts`
- **Функция**: `parseCompositionFlowers(composition: string): string[]`
- **Описание**: Парсит строку состава и извлекает названия цветов, удаляя числа, единицы измерения и скобки.

### 2. Компонент фильтров
- **Файл**: `src/components/catalog/flower-filter-buttons.tsx`
- **Компонент**: `FlowerFilterButtons`
- **Описание**: Отображает квадратные кнопки с названиями цветов. При клике устанавливает/убирает query параметр `flower` в URL.

### 3. Страница категории
- **Файл**: `src/app/magazine/[slug]/page.tsx`
- **Изменения**: 
  - Добавлена проверка категории "Цветы в составе" (slug: `cvety-v-sostave` или `flowers-in-composition`)
  - Добавлен компонент `FlowerFilterButtons` под списком категорий
  - Добавлена фильтрация товаров по query параметру `flower`

### 4. Админ-панель
- **Файл**: `src/app/admin/products/page.tsx`
- **Изменения**:
  - Добавлен блок выбора цветов (чекбоксы) для товаров в категории "Цветы в составе"
  - Список цветов загружается автоматически из всех товаров каталога
  - Выбранные цветы сохраняются в поле `composition_flowers`

### 5. API
- **Файлы**: 
  - `src/app/api/admin/products/route.ts` (POST)
  - `src/app/api/admin/products/[id]/route.ts` (PATCH, GET)
  - `src/app/api/admin/flowers/route.ts` (GET - список всех цветов)
- **Изменения**: Добавлена поддержка поля `composition_flowers` (TEXT[])

### 6. База данных
- **Миграции**:
  - `scripts/migrations/products-add-composition-flowers.sql`
  - `scripts/migrations/variant-products-add-composition-flowers.sql`
  - `scripts/migrations/categories-add-flowers-in-composition.sql`
- **Поля**: 
  - `products.composition_flowers` (TEXT[])
  - `variant_products.composition_flowers` (TEXT[])

## Логика фильтрации

При фильтрации товаров используется приоритет:
1. Если у товара заполнено поле `composition_flowers` → используется оно
2. Если поле пустое → парсинг из поля `composition` через `parseCompositionFlowers`

## Использование

### Для администратора

1. **Создание/редактирование товара**:
   - Выберите категорию "Цветы в составе" в чекбоксах категорий
   - Появится блок "Цветы в составе" с чекбоксами
   - Отметьте цветы, входящие в букет
   - Сохраните товар

2. **Список цветов**:
   - Формируется автоматически из всех товаров каталога
   - Обновляется при каждом открытии формы создания/редактирования

### Для пользователя

1. Перейдите в категорию "Цветы в составе" (`/magazine/cvety-v-sostave`)
2. Под списком категорий появятся квадратные кнопки с названиями цветов
3. Кликните на кнопку с названием цветка → товары отфильтруются
4. Повторный клик по активной кнопке → фильтр снимается

## Установка

1. **Применить миграции БД**:
   ```sql
   -- В Supabase SQL Editor выполнить:
   -- 1. products-add-composition-flowers.sql
   -- 2. variant-products-add-composition-flowers.sql
   -- 3. categories-add-flowers-in-composition.sql
   ```

2. **Проверить категорию**:
   - Убедиться, что категория "Цветы в составе" создана (slug: `cvety-v-sostave`)
   - Если нет — выполнить миграцию `categories-add-flowers-in-composition.sql`

3. **Настроить товары**:
   - В админке добавить товары в категорию "Цветы в составе"
   - Выбрать цветы для каждого товара (или они будут автоматически распарсены из состава)

## Технические детали

- **Slug категории**: `cvety-v-sostave` (или `flowers-in-composition` для англоязычной версии)
- **Query параметр**: `?flower=название-цветка` (lowercase)
- **Сравнение**: case-insensitive по lowercase
- **Хранение**: массив строк в БД (TEXT[])

## Примеры

### Парсинг состава
```typescript
parseCompositionFlowers("Гортензия 1шт, Диантус 2шт")
// -> ["Гортензия", "Диантус"]

parseCompositionFlowers("Розы 7 шт + Гортензия 1шт")
// -> ["Гортензия", "Розы"]
```

### URL фильтрации
```
/magazine/cvety-v-sostave?flower=гортензия
```

### Структура данных
```typescript
{
  composition: "Гортензия 1шт, Диантус 2шт", // строка для отображения
  compositionFlowers: ["Гортензия", "Диантус"] // массив для фильтрации
}
```

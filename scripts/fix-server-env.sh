#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∏ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

set -e

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∏ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
echo ""

cd /var/www/theame || {
    echo "‚ùå –û—à–∏–±–∫–∞: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /var/www/theame –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    exit 1
}

# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ PM2
echo "‚èπÔ∏è  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2..."
pm2 stop nextjs-project 2>/dev/null || true
pm2 delete nextjs-project 2>/dev/null || true

# 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ .env.production —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -f ".env.production" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª .env.production –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "üí° –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –∫–æ–º–∞–Ω–¥–æ–π –∏–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏"
    exit 1
fi

echo "‚úÖ –§–∞–π–ª .env.production –Ω–∞–π–¥–µ–Ω"

# 3. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é
echo "üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env.production..."
export $(cat .env.production | grep -v '^#' | xargs)

# 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∫–ª—é—á–µ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ] || [ -z "$TELEGRAM_BOT_TOKEN" ]; then
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å"
    echo "   NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL:+SET}"
    echo "   TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:+SET}"
fi

# 5. –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—É—é —Å–±–æ—Ä–∫—É
echo "üóëÔ∏è  –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å–±–æ—Ä–∫—É..."
rm -rf .next

# 6. –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
echo "üì• –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
git pull origin main || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º..."

# 7. –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –° –ü–ï–†–ï–ú–ï–ù–ù–´–ú–ò –í –û–ö–†–£–ñ–ï–ù–ò–ò
echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç)..."
npm run build

# 8. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Å–±–æ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
if [ ! -f ".next/prerender-manifest.json" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –°–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å - —Ñ–∞–π–ª prerender-manifest.json –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

echo "‚úÖ –°–±–æ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ"

# 9. –ó–∞–ø—É—Å—Ç–∏—Ç–µ PM2
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º PM2..."
pm2 start ecosystem.config.js
pm2 save

# 10. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ
echo "‚è≥ –ñ–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã..."
sleep 3

# 11. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å
echo ""
echo "üìä –°—Ç–∞—Ç—É—Å PM2:"
pm2 status

echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
echo "   pm2 logs nextjs-project --lines 30"
echo ""
echo "üß™ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π endpoint:"
echo "   curl https://theame.ru/api/payments/tinkoff/notify/check"

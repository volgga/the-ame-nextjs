# Чек-лист тестирования после применения RLS миграций

## Перед применением миграций

1. ✅ Сделать бэкап базы данных
2. ✅ Применить миграции на тестовой/локальной БД
3. ✅ Проверить что все таблицы имеют RLS включен (`supabase/checks.sql`)

## Тестирование публичного доступа (anon key)

### Каталог товаров
- [ ] Главная страница открывается
- [ ] Каталог товаров загружается (`/magazin`)
- [ ] Фильтрация по категориям работает
- [ ] Фильтрация по цветам работает
- [ ] Фильтрация по поводам работает
- [ ] Поиск товаров работает
- [ ] Страница товара открывается (`/product/[slug]`)
- [ ] Вариантные товары отображаются корректно
- [ ] Цены и скидки отображаются корректно

### Контент
- [ ] Блог открывается (`/clients/blog`)
- [ ] Статья блога открывается (`/clients/blog/[slug]`)
- [ ] Главная страница загружается (hero слайды, коллекции, отзывы, FAQ)
- [ ] Страница "О нас" открывается (`/about`)
- [ ] Страница корпоративов открывается (`/corporate`)

### Доставка и промокоды
- [ ] Зоны доставки загружаются в форме заказа
- [ ] Дни доставки загружаются
- [ ] Временные слоты доставки загружаются
- [ ] Проверка промокода работает
- [ ] Правила минимального заказа работают

### Формы и заказы
- [ ] Создание заказа из корзины работает (`POST /api/orders`)
- [ ] Форма "Заказать букет" работает (`POST /api/forms/bouquet`)
- [ ] Форма "Намекнуть о подарке" работает (`POST /api/gift-hints`)
- [ ] Форма "Предзаказ" работает (`POST /api/forms/preorder`)
- [ ] Форма "Купить в 1 клик" работает (`POST /api/one-click-order`)

## Тестирование админки (service role)

### Админские операции
- [ ] Вход в админку работает
- [ ] Список товаров загружается (`/admin/products`)
- [ ] Создание товара работает
- [ ] Редактирование товара работает
- [ ] Удаление товара работает
- [ ] Управление вариантами товаров работает
- [ ] Управление категориями работает
- [ ] Управление блогом работает
- [ ] Управление слайдами работает
- [ ] Управление коллекциями работает
- [ ] Управление отзывами работает
- [ ] Управление зонами доставки работает
- [ ] Управление промокодами работает
- [ ] Управление правилами минимального заказа работает

### Чтение заказов и лидов
- [ ] Список заказов загружается (если есть админка для заказов)
- [ ] Детали заказа открываются
- [ ] Обновление статуса заказа работает
- [ ] Лиды отображаются (если есть админка для лидов)

## Тестирование безопасности

### Проверка что anon не может читать чувствительные данные
- [ ] Попытка SELECT из `orders` через anon key должна вернуть ошибку (кроме INSERT)
- [ ] Попытка SELECT из `leads` через anon key должна вернуть ошибку (кроме INSERT)
- [ ] Попытка UPDATE/DELETE из публичных таблиц через anon key должна вернуть ошибку

### Проверка что service role имеет полный доступ
- [ ] Service role может читать все таблицы
- [ ] Service role может писать во все таблицы
- [ ] Service role может обновлять заказы

## Проверка производительности

После применения индексов:
- [ ] Загрузка каталога не замедлилась
- [ ] Фильтрация товаров работает быстро
- [ ] Поиск товаров работает быстро
- [ ] Загрузка страницы товара не замедлилась

## Мониторинг после деплоя

В течение первых 24 часов после деплоя:
- [ ] Проверить логи ошибок в Supabase Dashboard
- [ ] Проверить метрики производительности
- [ ] Проверить что нет ошибок 401/403 на сайте
- [ ] Проверить что формы заказов работают

## Команды для проверки

```bash
# Локально: запустить dev сервер
npm run dev

# Проверить что сайт открывается
curl http://localhost:3000

# Проверить что каталог загружается
curl http://localhost:3000/magazin

# Проверить что API работает
curl -X POST http://localhost:3000/api/orders \
  -H "Content-Type: application/json" \
  -d '{"items":[],"customer":{}}'
```

## Если что-то сломалось

1. Проверить логи Supabase Dashboard → Logs → Postgres Logs
2. Проверить что RLS включен: выполнить `supabase/checks.sql`
3. Проверить что policies созданы: `SELECT * FROM pg_policies WHERE schemaname = 'public';`
4. Если критично — использовать план отката из `ROLLBACK.md`

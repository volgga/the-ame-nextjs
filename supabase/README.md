# Supabase Миграции и Безопасность — The Ame

## Структура папки

```
supabase/
├── migrations/          # SQL миграции (применяются по порядку)
├── checks.sql          # SQL запросы для проверки состояния БД
├── INVENTORY.md        # Инвентаризация таблиц и их использования
└── README.md           # Этот файл
```

## Применение миграций

### Локально (через Supabase CLI)

```bash
# Применить все миграции
supabase db reset

# Или применить конкретную миграцию
supabase migration up
```

### В проде (через Supabase Dashboard)

1. Откройте Supabase Dashboard → SQL Editor
2. Скопируйте содержимое миграции
3. Выполните по порядку (начиная с `20250216000001`)
4. Проверьте результат через `checks.sql`

## Порядок применения миграций

1. **20250216000000_fix_existing_policies.sql** (опционально)
   - Исправляет старые policies с неправильным синтаксисом
   - Применяется только если в БД уже есть старые policies

2. **20250216000001_enable_rls_all_tables.sql**
   - Включает RLS на всех таблицах
   - ⚠️ Безопасно: только включает RLS, не блокирует доступ

3. **20250216000002_policies_public_read_only.sql**
   - Добавляет policies для публичного чтения
   - ⚠️ Проверьте что сайт работает после применения

4. **20250216000003_policies_public_insert.sql**
   - Добавляет policies для публичной вставки (заказы, лиды)
   - ⚠️ Проверьте что формы заказов работают

5. **20250216000004_policies_join_tables.sql**
   - Добавляет policies для join таблиц
   - ⚠️ Проверьте что фильтрация работает

6. **20250216000005_indexes_performance.sql**
   - Создает индексы для производительности
   - ⚠️ Для больших таблиц используйте CONCURRENTLY в проде

7. **20250216000006_add_image_variants.sql**
   - Добавляет поля для предгенерированных вариантов изображений
   - После применения запустите `npm run migrate-images` для генерации превью

## Проверка состояния

Выполните `checks.sql` в Supabase SQL Editor для проверки:
- Таблицы без RLS
- Таблицы без policies
- Публичные привилегии
- Индексы

## Тестирование

После применения миграций проверьте:
1. Публичный доступ к каталогу, блогу, страницам товаров
2. Работу админки (создание/редактирование товаров)
3. Оформление заказов и отправку форм
4. Производительность запросов

## Безопасность

После применения всех миграций:
- ✅ Все таблицы имеют RLS включен
- ✅ Публичные таблицы доступны только для чтения
- ✅ Таблицы заказов/лидов доступны только для вставки
- ✅ Админские операции только через service role
- ✅ Чувствительные данные защищены

## Мониторинг

После деплоя проверьте:
- Логи Supabase Dashboard → Logs → Postgres Logs
- Метрики производительности
- Ошибки 401/403 на сайте
- Работу форм заказов

## Поддержка

При проблемах:
1. Проверьте `checks.sql` для диагностики
2. Проверьте логи Supabase
3. Используйте план отката если критично
4. Свяжитесь с командой разработки

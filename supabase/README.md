# Supabase Миграции и Безопасность — The Ame

## Структура папки

```
supabase/
├── migrations/          # SQL миграции (применяются по порядку)
├── checks.sql          # SQL запросы для проверки состояния БД
├── INVENTORY.md        # Инвентаризация таблиц и их использования
├── ROLLBACK.md         # План отката миграций
├── TESTING_CHECKLIST.md # Чек-лист тестирования
├── UNUSED_TABLES_AUDIT.md # Аудит неиспользуемых таблиц
└── README.md           # Этот файл
```

## Применение миграций

### Локально (через Supabase CLI)

```bash
# Применить все миграции
supabase db reset

# Или применить конкретную миграцию
supabase migration up
```

### В проде (через Supabase Dashboard)

1. Откройте Supabase Dashboard → SQL Editor
2. Скопируйте содержимое миграции
3. Выполните по порядку (начиная с `20250216000001`)
4. Проверьте результат через `checks.sql`

## Порядок применения миграций

1. **20250216000001_enable_rls_all_tables.sql**
   - Включает RLS на всех таблицах
   - ⚠️ Безопасно: только включает RLS, не блокирует доступ

2. **20250216000002_policies_public_read_only.sql**
   - Добавляет policies для публичного чтения
   - ⚠️ Проверьте что сайт работает после применения

3. **20250216000003_policies_public_insert.sql**
   - Добавляет policies для публичной вставки (заказы, лиды)
   - ⚠️ Проверьте что формы заказов работают

4. **20250216000004_policies_join_tables.sql**
   - Добавляет policies для join таблиц
   - ⚠️ Проверьте что фильтрация работает

5. **20250216000005_indexes_performance.sql**
   - Создает индексы для производительности
   - ⚠️ Для больших таблиц используйте CONCURRENTLY в проде

## Проверка состояния

Выполните `checks.sql` в Supabase SQL Editor для проверки:
- Таблицы без RLS
- Таблицы без policies
- Публичные привилегии
- Индексы

## Тестирование

Следуйте чек-листу из `TESTING_CHECKLIST.md`:
1. Тестирование публичного доступа
2. Тестирование админки
3. Тестирование безопасности
4. Проверка производительности

## Откат

Если что-то пошло не так, используйте план из `ROLLBACK.md`.

⚠️ **ВНИМАНИЕ**: Откат временно открывает доступ к данным. Используйте только в критических случаях.

## Безопасность

После применения всех миграций:
- ✅ Все таблицы имеют RLS включен
- ✅ Публичные таблицы доступны только для чтения
- ✅ Таблицы заказов/лидов доступны только для вставки
- ✅ Админские операции только через service role
- ✅ Чувствительные данные защищены

## Мониторинг

После деплоя проверьте:
- Логи Supabase Dashboard → Logs → Postgres Logs
- Метрики производительности
- Ошибки 401/403 на сайте
- Работу форм заказов

## Поддержка

При проблемах:
1. Проверьте `checks.sql` для диагностики
2. Проверьте логи Supabase
3. Используйте план отката если критично
4. Свяжитесь с командой разработки

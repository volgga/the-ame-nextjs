name: Deploy to server

on:
  push:
    branches: ["main"]

# –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –¥–µ–ø–ª–æ–µ–≤
concurrency:
  group: deploy
  cancel-in-progress: false

env:
  SITE_URL: https://theame.ru
  NEXT_PUBLIC_SITE_URL: https://theame.ru
  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH || '/var/www/theame' }}
  PM2_APP_NAME: ${{ secrets.PM2_APP_NAME || 'theame-next' }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          envs: SITE_URL,NEXT_PUBLIC_SITE_URL,DEPLOY_PATH,PM2_APP_NAME
          command_timeout: 30m
          script: |
            set -euo pipefail
            
            DEPLOY_PATH="${DEPLOY_PATH:-/var/www/theame}"
            PM2_APP_NAME="${PM2_APP_NAME:-theame-next}"
            
            # –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–∏: –µ—Å–ª–∏ DEPLOY_PATH –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏—â–µ–º –ø—Ä–æ–µ–∫—Ç –≤ —Ç–∏–ø–∏—á–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
            if [ ! -d "$DEPLOY_PATH" ] || [ ! -f "$DEPLOY_PATH/package.json" ]; then
              echo "‚ö†Ô∏è  DEPLOY_PATH ($DEPLOY_PATH) –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç package.json, –∏—â–µ–º –ø—Ä–æ–µ–∫—Ç..."
              for try_path in /var/www/theame /var/www/nextjs-project /var/www/theame-nextjs /var/www/theame-next /home/ubuntu/theame /home/ubuntu/nextjs-project /home/deploy/theame; do
                if [ -d "$try_path" ] && [ -f "$try_path/package.json" ] && [ -f "$try_path/ecosystem.config.cjs" ]; then
                  DEPLOY_PATH="$try_path"
                  echo "‚úÖ –ù–∞–π–¥–µ–Ω –ø—Ä–æ–µ–∫—Ç: $DEPLOY_PATH"
                  break
                fi
              done
            fi
            
            echo "üöÄ Starting deployment..."
            echo "üìÅ Deploy path: $DEPLOY_PATH"
            echo "üîÑ PM2 app name: $PM2_APP_NAME"
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd "$DEPLOY_PATH" || {
              echo "‚ùå Error: Directory $DEPLOY_PATH does not exist"
              echo "üí° –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å —á–µ—Ä–µ–∑ GitHub Secret: DEPLOY_PATH"
              exit 1
            }
            
            # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
            echo "üìÇ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ DEPLOY_PATH (ls -la):"
            ls -la
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
            echo "üì• Fetching latest code..."
            
            # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º DNS –¥–ª—è systemd-resolved (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            echo "üîß Configuring DNS..."
            if command -v resolvectl >/dev/null 2>&1; then
              echo "üìã Current DNS status:"
              resolvectl status || true
              echo "üîß Setting DNS servers..."
              resolvectl dns eth0 8.8.8.8 8.8.4.4 2>/dev/null || resolvectl dns $(ip route | grep default | awk '{print $5}' | head -1) 8.8.8.8 8.8.4.4 2>/dev/null || true
            fi
            
            # –û–±–Ω–æ–≤–ª—è–µ–º /etc/resolv.conf –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
            if [ -L /etc/resolv.conf ]; then
              echo "üìù /etc/resolv.conf is a symlink, checking systemd-resolved..."
            else
              echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf.tmp >/dev/null 2>&1 || true
              echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf.tmp >/dev/null 2>&1 || true
            fi
            
            # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º git remote
            echo "üîç Checking git remote configuration..."
            git remote -v || echo "‚ö†Ô∏è Warning: git remote check failed"
            
            # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å GitHub
            echo "üîç Testing GitHub connectivity..."
            if ping -c 1 github.com >/dev/null 2>&1 || ping -c 1 140.82.121.3 >/dev/null 2>&1; then
              echo "‚úÖ GitHub is reachable"
            else
              echo "‚ö†Ô∏è Warning: GitHub ping failed, but continuing..."
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º git remote URL –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–∞ HTTPS
            GIT_REMOTE_URL=$(git config --get remote.origin.url || echo "")
            if [[ "$GIT_REMOTE_URL" == *"git@"* ]]; then
              echo "üîç Git remote uses SSH, checking if we can use HTTPS instead..."
              # –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS –µ—Å–ª–∏ SSH –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
              GIT_REPO_NAME=$(echo "$GIT_REMOTE_URL" | sed -E 's/.*[:/]([^/]+\/[^/]+)(\.git)?$/\1/' | sed 's/\.git$//')
              if [ -n "$GIT_REPO_NAME" ]; then
                echo "üí° Alternative: git remote set-url origin https://github.com/$GIT_REPO_NAME.git"
                # –ù–µ –º–µ–Ω—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º
              fi
            fi
            
            # –ü—Ä–æ–±—É–µ–º fetch —Å —Ç–∞–π–º–∞—É—Ç–æ–º –∏ retry
            MAX_RETRIES=3
            RETRY_COUNT=0
            FETCH_SUCCESS=false
            
            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º DNS —á–µ—Ä–µ–∑ systemd-resolved
            echo "üîß Configuring DNS via systemd-resolved..."
            if command -v resolvectl >/dev/null 2>&1; then
              # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
              INTERFACE=$(ip route | grep default | awk '{print $5}' | head -1 || echo "eth0")
              echo "üì° Using interface: $INTERFACE"
              
              # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º DNS —Å–µ—Ä–≤–µ—Ä—ã
              resolvectl dns "$INTERFACE" 8.8.8.8 8.8.4.4 2>/dev/null || true
              
              # –û—á–∏—â–∞–µ–º DNS –∫–µ—à
              echo "üîÑ Flushing DNS cache..."
              resolvectl flush-caches 2>/dev/null || true
            fi
            
            # –î–æ–±–∞–≤–ª—è–µ–º GitHub –≤ /etc/hosts –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            echo "üìù Adding GitHub to /etc/hosts..."
            if ! grep -q "github.com" /etc/hosts 2>/dev/null; then
              GITHUB_IPS="140.82.121.3 140.82.121.4"
              for IP in $GITHUB_IPS; do
                if ping -c 1 -W 2 "$IP" >/dev/null 2>&1; then
                  echo "$IP github.com" | sudo tee -a /etc/hosts >/dev/null 2>&1 || true
                  echo "‚úÖ Added $IP -> github.com to /etc/hosts"
                  break
                fi
              done
            else
              echo "‚úÖ GitHub already in /etc/hosts"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑–æ–ª–≤–∏–Ω–≥
            echo "üîç Testing DNS resolution..."
            if getent hosts github.com >/dev/null 2>&1; then
              echo "‚úÖ github.com resolves to: $(getent hosts github.com | awk '{print $1}')"
            else
              echo "‚ö†Ô∏è Warning: github.com DNS resolution failed"
            fi
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "üîÑ Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: Fetching from origin/main..."
              
              # –ü—Ä–æ–±—É–µ–º fetch —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º
              if timeout 60 git fetch origin main 2>&1; then
                FETCH_SUCCESS=true
                break
              else
                FETCH_EXIT_CODE=$?
                echo "‚ö†Ô∏è Fetch attempt failed with exit code: $FETCH_EXIT_CODE"
                
                # –ï—Å–ª–∏ —ç—Ç–æ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –ø—Ä–æ–±—É–µ–º —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –æ–ø—Ü–∏—è–º–∏
                if [[ "$GIT_REMOTE_URL" == *"git@"* ]]; then
                  echo "üí° Retrying with SSH options..."
                  GIT_SSH_COMMAND="ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
                  timeout 60 git fetch origin main 2>&1 || true
                fi
                
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "‚è≥ Waiting 5 seconds before retry..."
                  sleep 5
                fi
              fi
            done
            
            if [ "$FETCH_SUCCESS" = false ]; then
              echo "‚ùå Error: Failed to fetch from origin/main after $MAX_RETRIES attempts"
              echo "üîç Debug info:"
              echo "  Git remote URL: $(git config --get remote.origin.url || echo 'not set')"
              echo "  Current branch: $(git branch --show-current || echo 'unknown')"
              echo "  Last commit: $(git log -1 --oneline || echo 'unknown')"
              echo ""
              echo "üí° Trying alternative: pull directly..."
              if timeout 30 git pull origin main 2>&1; then
                echo "‚úÖ Pull succeeded as fallback"
              else
                echo "‚ùå Pull also failed - this is a network/DNS issue on the server"
                echo "üí° Solutions:"
                echo "  1. Check DNS settings on server: /etc/resolv.conf"
                echo "  2. Try: echo 'nameserver 8.8.8.8' | sudo tee -a /etc/resolv.conf"
                echo "  3. Or wait for network to recover"
                echo "  4. Or deploy manually via rsync from GitHub Actions"
                exit 1
              fi
            else
              echo "‚úÖ Fetch succeeded"
              echo "üîÑ Resetting to origin/main..."
              git reset --hard origin/main || {
                echo "‚ùå Error: Failed to reset to origin/main"
                exit 1
              }
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ nvm –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å
            if [ -s "$HOME/.nvm/nvm.sh" ]; then
              echo "üì¶ Loading nvm..."
              source "$HOME/.nvm/nvm.sh"
              nvm use 20 || nvm use default || true
            fi
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "üì¶ Installing dependencies..."
            # –£–¥–∞–ª—è–µ–º node_modules –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å npm ci
            if [ -d "node_modules" ]; then
              echo "üßπ Cleaning node_modules before install..."
              rm -rf node_modules || true
            fi
            npm ci || {
              echo "‚ö†Ô∏è  npm ci failed, trying npm install..."
              npm install || {
                echo "‚ùå Error: npm install failed"
                exit 1
              }
            }
            
            # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
            echo "üî® Building Next.js application..."
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—É—é –ø–∞–º—è—Ç—å
            echo "üíæ System memory info:"
            free -h || true
            echo ""
            
            # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç –ø–∞–º—è—Ç–∏ –¥–ª—è Node.js (4GB, –∞–¥–∞–ø—Ç–∏–≤–Ω–æ –ø–æ–¥ –¥–æ—Å—Ç—É–ø–Ω—É—é –ø–∞–º—è—Ç—å)
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—É—é –ø–∞–º—è—Ç—å –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–∏–º–∏—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ
            AVAILABLE_MEM=$(free -m | awk '/^Mem:/{print $7}' || echo "4096")
            TOTAL_MEM=$(free -m | awk '/^Mem:/{print $2}' || echo "4096")
            
            echo "üíæ Total RAM: ${TOTAL_MEM}MB"
            echo "üíæ Available RAM: ${AVAILABLE_MEM}MB"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º swap
            SWAP_TOTAL=$(free -m | awk '/^Swap:/{print $2}' || echo "0")
            SWAP_USED=$(free -m | awk '/^Swap:/{print $3}' || echo "0")
            if [ "$SWAP_TOTAL" -gt 0 ]; then
              echo "üíæ Swap: ${SWAP_TOTAL}MB total, ${SWAP_USED}MB used"
            fi
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–∏–º–∏—Ç –ø–∞–º—è—Ç–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–±—â–µ–π –ø–∞–º—è—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
            # –î–ª—è —Å–±–æ—Ä–∫–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏, —Ç–∞–∫ –∫–∞–∫ –µ—Å—Ç—å swap (2GB)
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â—É—é –ø–∞–º—è—Ç—å (TOTAL_MEM), –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—É—é (AVAILABLE_MEM)
            if [ "$TOTAL_MEM" -lt 1024 ]; then
              # –°–µ—Ä–≤–µ—Ä —Å 1GB RAM - –∏—Å–ø–æ–ª—å–∑—É–µ–º 1GB –¥–ª—è —Å–±–æ—Ä–∫–∏ (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π swap)
              # –≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ —É –Ω–∞—Å –µ—Å—Ç—å 2GB swap
              NODE_MEM_LIMIT=1024
              echo "‚ö†Ô∏è  Low memory server (${TOTAL_MEM}MB total, ${AVAILABLE_MEM}MB available), using ${NODE_MEM_LIMIT}MB limit for build (with swap support)"
            elif [ "$TOTAL_MEM" -lt 2048 ]; then
              # –°–µ—Ä–≤–µ—Ä —Å 1-2GB RAM - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ 1.5GB –¥–ª—è —Å–±–æ—Ä–∫–∏
              NODE_MEM_LIMIT=1536
              echo "‚ÑπÔ∏è  Medium memory server (${TOTAL_MEM}MB total, ${AVAILABLE_MEM}MB available), using ${NODE_MEM_LIMIT}MB limit"
            elif [ "$TOTAL_MEM" -lt 4096 ]; then
              # –°–µ—Ä–≤–µ—Ä —Å 2-4GB RAM - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ 2GB –¥–ª—è —Å–±–æ—Ä–∫–∏
              NODE_MEM_LIMIT=2048
              echo "‚úÖ Good memory server (${TOTAL_MEM}MB total, ${AVAILABLE_MEM}MB available), using ${NODE_MEM_LIMIT}MB limit"
            else
              # –°–µ—Ä–≤–µ—Ä —Å 4GB+ RAM - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ 3GB –¥–ª—è —Å–±–æ—Ä–∫–∏
              NODE_MEM_LIMIT=3072
              echo "‚úÖ Sufficient memory server (${TOTAL_MEM}MB total, ${AVAILABLE_MEM}MB available), using ${NODE_MEM_LIMIT}MB limit"
            fi
            
            export NODE_OPTIONS="--max-old-space-size=${NODE_MEM_LIMIT}"
            echo "üìä NODE_OPTIONS set to: $NODE_OPTIONS"
            
            # –ù–ï —É–¥–∞–ª—è–µ–º .next ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º Incremental Cache –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ Egress –ø—Ä–∏ –¥–µ–ø–ª–æ–µ.
            # –í–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å —Å—Å—ã–ª–æ–∫ (?v=updated_at) –æ–±–Ω–æ–≤–∏—Ç —Ñ–æ—Ç–æ –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.
            
            # –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ webpack –≤–º–µ—Å—Ç–æ Turbopack
            echo "üî® Starting build with webpack..."
            echo "üìä Using NODE_OPTIONS: --max-old-space-size=${NODE_MEM_LIMIT}"
            
            # –û—á–∏—â–∞–µ–º –∫–µ—à npm –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏
            echo "üßπ Cleaning npm cache..."
            npm cache clean --force || true
            
            # –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∏–ø–æ–≤ TypeScript –≤–æ –≤—Ä–µ–º—è —Å–±–æ—Ä–∫–∏ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
            # TypeScript –ø—Ä–æ–≤–µ—Ä–∫–∞ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
            export SKIP_ENV_VALIDATION=true
            export NEXT_TELEMETRY_DISABLED=1
            
            # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ NODE_OPTIONS –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ npm run build
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–∞–ª–æ–º–æ—â–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
            if [ "$AVAILABLE_MEM" -lt 1024 ]; then
              echo "‚ö†Ô∏è  Low memory server detected - using minimal build settings"
              # –î–ª—è –º–∞–ª–æ–º–æ—â–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–Ω—å—à–µ –≤–æ—Ä–∫–µ—Ä–æ–≤ –∏ –æ—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∏–ø–æ–≤
              NODE_OPTIONS="--max-old-space-size=${NODE_MEM_LIMIT}" TYPESCRIPT_CHECK=false npm run build -- --webpack || {
                echo "‚ùå Error: Build failed on low-memory server"
                echo ""
                echo "üìä Memory diagnostics:"
                free -h || true
                echo ""
                echo "üí° Troubleshooting for low-memory servers:"
                echo "   1. Upgrade server RAM to at least 2GB (recommended: 4GB+)"
                echo "   2. Increase swap space: sudo fallocate -l 4G /swapfile && sudo chmod 600 /swapfile && sudo mkswap /swapfile && sudo swapon /swapfile"
                echo "   3. Free up memory: stop unnecessary services, clear caches"
                echo "   4. Consider building locally and deploying pre-built files"
                exit 1
              }
            else
              # –î–ª—è —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç—å—é —Ç–æ–∂–µ –æ—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∏–ø–æ–≤ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
              NODE_OPTIONS="--max-old-space-size=${NODE_MEM_LIMIT}" SKIP_TYPES_CHECK=true npm run build -- --webpack || {
                echo "‚ùå Error: Build failed"
                echo ""
                echo "üìä Memory diagnostics:"
                free -h || true
                echo ""
                echo "üí° Troubleshooting:"
                echo "   1. Check if server has enough RAM (recommended: 4GB+)"
                echo "   2. Check if swap is enabled: swapon --show"
                echo "   3. Check build logs above for OOM (Out of Memory) errors"
                echo "   4. Try increasing NODE_MEM_LIMIT or adding swap space"
                exit 1
              }
            fi
            
            # –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏–∫—É –¥–ª—è standalone (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã!)
            echo "üìÅ Copying static assets and server files for standalone..."
            mkdir -p .next/standalone/.next/server
            cp -r public .next/standalone/public
            cp -r .next/static .next/standalone/.next/static
            cp -r .next/server .next/standalone/.next/
            
            mkdir -p logs
            
            # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ–¥ PM2: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤–∏–¥–∏–º –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã
            echo "üìÇ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–µ—Ä–µ–¥ PM2 (ls -la):"
            ls -la
            echo "üìÇ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤:"
            ls -la package.json ecosystem.config.cjs .next/BUILD_ID 2>/dev/null || true
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ (ecosystem –∏ package.json)
            if [ ! -f "ecosystem.config.cjs" ] || [ ! -f "package.json" ]; then
              echo "‚ùå Error: ecosystem.config.cjs or package.json not found in $(pwd)"
              echo "   Expected project root: $DEPLOY_PATH"
              echo "   Current directory: $(pwd)"
              exit 1
            fi
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∏–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å (startOrRestart = —Å—Ç–∞—Ä—Ç –∏–ª–∏ —Ä–µ—Å—Ç–∞—Ä—Ç)
            echo "üîÑ Restarting/Starting PM2 process..."
            if command -v pm2 >/dev/null 2>&1; then
              # –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å PM2 –¥–æ –¥–µ–ø–ª–æ—è
              echo "üìã PM2 processes BEFORE deploy:"
              pm2 list || true
              echo ""
              
              # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ/–±–∏—Ç—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã —Å –ª—é–±—ã–º–∏ –∏–º–µ–Ω–∞–º–∏
              pm2 delete "$PM2_APP_NAME" 2>/dev/null || true
              pm2 delete "nextjs-project" 2>/dev/null || true
              pm2 delete "theame" 2>/dev/null || true
              pm2 delete "theame-next" 2>/dev/null || true
              echo ""
              
              # –ó–∞–ø—É—Å–∫ –∏–∑ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (restart = –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–ª–∏ —Å—Ç–∞—Ä—Ç, –µ—Å–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω)
              echo "üöÄ Starting PM2 from $(pwd)..."
              PM2_CWD="$(pwd)" pm2 restart ecosystem.config.cjs --update-env || {
                echo "‚ö†Ô∏è  restart failed (app may not exist), trying pm2 start..."
                PM2_CWD="$(pwd)" pm2 start ecosystem.config.cjs || {
                  echo "‚ùå Failed to start PM2 process"
                  exit 1
                }
              }
              
              # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é PM2
              pm2 save || true
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞
              echo ""
              echo "üìä PM2 list AFTER deploy:"
              pm2 list
              
              # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω
              sleep 5
              if pm2 describe "$PM2_APP_NAME" >/dev/null 2>&1; then
                STATUS=$(pm2 jlist 2>/dev/null | grep -o "\"name\":\"$PM2_APP_NAME\".*\"pm_id\":[0-9]*" | grep -o "\"status\":\"[^\"]*\"" | cut -d'"' -f4 || echo "unknown")
                echo "‚úÖ Process '$PM2_APP_NAME' is running (status: ${STATUS})"
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç
                echo "üîç Checking if application is responding..."
                sleep 2
                if curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 > /dev/null 2>&1; then
                  HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000)
                  echo "‚úÖ Application is responding on localhost:3000 (HTTP $HTTP_CODE)"
                else
                  echo "‚ö†Ô∏è  Warning: Application is not responding on localhost:3000"
                  echo "üìã Recent PM2 logs:"
                  pm2 logs "$PM2_APP_NAME" --lines 20 --nostream || true
                fi
              else
                echo "‚ö†Ô∏è  Warning: Process '$PM2_APP_NAME' may not be running properly"
                pm2 list
                echo ""
                echo "üìã Recent PM2 error logs:"
                pm2 logs "$PM2_APP_NAME" --err --lines 30 --nostream || true
              fi
            else
              echo "‚ùå Error: PM2 is not installed or not in PATH"
              echo "üí° Hint: Install PM2 with: npm install -g pm2"
              echo "üí° Hint: Then start the app with: pm2 start ecosystem.config.cjs"
              exit 1
            fi
            
            # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∞—É–¥–∏—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ ‚Äî –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –¥–µ–ø–ª–æ–π –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö)
            echo ""
            echo "üîç –í—ã–ø–æ–ª–Ω—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É..."
            if [ -f "scripts/server-setup-and-audit.sh" ]; then
              echo "üìã –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∞—É–¥–∏—Ç–∞ (DEPLOY_PATH=$DEPLOY_PATH)..."
              DEPLOY_PATH="$DEPLOY_PATH" PM2_APP_NAME="$PM2_APP_NAME" bash scripts/server-setup-and-audit.sh 2>&1 || {
                echo "‚ö†Ô∏è  –°–∫—Ä–∏–ø—Ç –∞—É–¥–∏—Ç–∞ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏ (–≤–æ–∑–º–æ–∂–Ω–æ —Ç—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ sudo), –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ"
              }
            else
              echo "‚ÑπÔ∏è  –°–∫—Ä–∏–ø—Ç –∞—É–¥–∏—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω (scripts/server-setup-and-audit.sh), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
            fi
            
            echo ""
            echo "‚úÖ Deployment completed successfully!"

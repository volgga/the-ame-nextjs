name: Deploy to server

on:
  push:
    branches: ["main"]

# Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ´ĞµĞ¿Ğ»Ğ¾ĞµĞ²
concurrency:
  group: deploy
  cancel-in-progress: false

env:
  SITE_URL: https://theame.ru
  NEXT_PUBLIC_SITE_URL: https://theame.ru

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          envs: SITE_URL,NEXT_PUBLIC_SITE_URL
          script: |
            set -euo pipefail
            
            DEPLOY_PATH="${DEPLOY_PATH:-/var/www/theame}"
            PM2_APP_NAME="${PM2_APP_NAME:-nextjs-project}"
            
            echo "ğŸš€ Starting deployment..."
            echo "ğŸ“ Deploy path: $DEPLOY_PATH"
            echo "ğŸ”„ PM2 app name: $PM2_APP_NAME"
            
            # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
            cd "$DEPLOY_PATH" || {
              echo "âŒ Error: Directory $DEPLOY_PATH does not exist"
              exit 1
            }
            
            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ´ Ğ¸Ğ· Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
            echo "ğŸ“¥ Fetching latest code..."
            
            # Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ git remote
            echo "ğŸ” Checking git remote configuration..."
            git remote -v || echo "âš ï¸ Warning: git remote check failed"
            
            # Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ GitHub
            echo "ğŸ” Testing GitHub connectivity..."
            if ping -c 1 github.com >/dev/null 2>&1 || ping -c 1 140.82.121.3 >/dev/null 2>&1; then
              echo "âœ… GitHub is reachable"
            else
              echo "âš ï¸ Warning: GitHub ping failed, but continuing..."
            fi
            
            # ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ fetch Ñ Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚Ğ¾Ğ¼ Ğ¸ retry
            MAX_RETRIES=3
            RETRY_COUNT=0
            FETCH_SUCCESS=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "ğŸ”„ Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: Fetching from origin/main..."
              if timeout 30 git fetch origin main 2>&1; then
                FETCH_SUCCESS=true
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "â³ Waiting 5 seconds before retry..."
                  sleep 5
                fi
              fi
            done
            
            if [ "$FETCH_SUCCESS" = false ]; then
              echo "âŒ Error: Failed to fetch from origin/main after $MAX_RETRIES attempts"
              echo "ğŸ” Debug info:"
              echo "  Git remote URL: $(git config --get remote.origin.url || echo 'not set')"
              echo "  Current branch: $(git branch --show-current || echo 'unknown')"
              echo "  Last commit: $(git log -1 --oneline || echo 'unknown')"
              echo ""
              echo "ğŸ’¡ Trying alternative: pull directly..."
              if timeout 30 git pull origin main 2>&1; then
                echo "âœ… Pull succeeded as fallback"
              else
                echo "âŒ Pull also failed - this is a network/DNS issue on the server"
                echo "ğŸ’¡ Solutions:"
                echo "  1. Check DNS settings on server: /etc/resolv.conf"
                echo "  2. Try: echo 'nameserver 8.8.8.8' | sudo tee -a /etc/resolv.conf"
                echo "  3. Or wait for network to recover"
                echo "  4. Or deploy manually via rsync from GitHub Actions"
                exit 1
              fi
            else
              echo "âœ… Fetch succeeded"
              echo "ğŸ”„ Resetting to origin/main..."
              git reset --hard origin/main || {
                echo "âŒ Error: Failed to reset to origin/main"
                exit 1
              }
            fi
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ nvm Ğ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµĞ¼ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ
            if [ -s "$HOME/.nvm/nvm.sh" ]; then
              echo "ğŸ“¦ Loading nvm..."
              source "$HOME/.nvm/nvm.sh"
              nvm use 20 || nvm use default || true
            fi
            
            # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
            echo "ğŸ“¦ Installing dependencies..."
            npm ci || {
              echo "âŒ Error: npm ci failed"
              exit 1
            }
            
            # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚
            echo "ğŸ”¨ Building Next.js application..."
            npm run build || {
              echo "âŒ Error: Build failed"
              exit 1
            }
            
            # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ PM2 Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ
            echo "ğŸ”„ Restarting/Starting PM2 process..."
            if command -v pm2 >/dev/null 2>&1; then
              if pm2 describe "$PM2_APP_NAME" >/dev/null 2>&1; then
                pm2 restart "$PM2_APP_NAME" && echo "âœ… PM2 process '$PM2_APP_NAME' restarted"
              else
                echo "Process '$PM2_APP_NAME' not found, cleaning and starting..."
                pm2 delete "$PM2_APP_NAME" 2>/dev/null || true
                pm2 delete "theame-next" 2>/dev/null || true
                pm2 start ecosystem.config.js
                echo "âœ… PM2 process started"
              fi
              pm2 save || true
            else
              echo "âŒ Error: PM2 is not installed or not in PATH"
              echo "ğŸ’¡ Hint: Install PM2 with: npm install -g pm2"
              echo "ğŸ’¡ Hint: Then start the app with: pm2 start ecosystem.config.js"
              exit 1
            fi
            
            echo "âœ… Deployment completed successfully!"

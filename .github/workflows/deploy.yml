name: Deploy to server

on:
  push:
    branches: ["main"]

# Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ´ĞµĞ¿Ğ»Ğ¾ĞµĞ²
concurrency:
  group: deploy
  cancel-in-progress: false

env:
  SITE_URL: https://theame.ru
  NEXT_PUBLIC_SITE_URL: https://theame.ru

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          envs: SITE_URL,NEXT_PUBLIC_SITE_URL
          script: |
            set -euo pipefail
            
            DEPLOY_PATH="${DEPLOY_PATH:-/var/www/theame}"
            PM2_APP_NAME="${PM2_APP_NAME:-nextjs-project}"
            
            echo "ğŸš€ Starting deployment..."
            echo "ğŸ“ Deploy path: $DEPLOY_PATH"
            echo "ğŸ”„ PM2 app name: $PM2_APP_NAME"
            
            # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
            cd "$DEPLOY_PATH" || {
              echo "âŒ Error: Directory $DEPLOY_PATH does not exist"
              exit 1
            }
            
            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ´ Ğ¸Ğ· Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
            echo "ğŸ“¥ Fetching latest code..."
            
            # Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ DNS Ğ´Ğ»Ñ systemd-resolved (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾)
            echo "ğŸ”§ Configuring DNS..."
            if command -v resolvectl >/dev/null 2>&1; then
              echo "ğŸ“‹ Current DNS status:"
              resolvectl status || true
              echo "ğŸ”§ Setting DNS servers..."
              resolvectl dns eth0 8.8.8.8 8.8.4.4 2>/dev/null || resolvectl dns $(ip route | grep default | awk '{print $5}' | head -1) 8.8.8.8 8.8.4.4 2>/dev/null || true
            fi
            
            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ /etc/resolv.conf Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ ÑĞµÑÑĞ¸Ğ¸
            if [ -L /etc/resolv.conf ]; then
              echo "ğŸ“ /etc/resolv.conf is a symlink, checking systemd-resolved..."
            else
              echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf.tmp >/dev/null 2>&1 || true
              echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf.tmp >/dev/null 2>&1 || true
            fi
            
            # Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ git remote
            echo "ğŸ” Checking git remote configuration..."
            git remote -v || echo "âš ï¸ Warning: git remote check failed"
            
            # Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ GitHub
            echo "ğŸ” Testing GitHub connectivity..."
            if ping -c 1 github.com >/dev/null 2>&1 || ping -c 1 140.82.121.3 >/dev/null 2>&1; then
              echo "âœ… GitHub is reachable"
            else
              echo "âš ï¸ Warning: GitHub ping failed, but continuing..."
            fi
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ git remote URL Ğ¸ Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ° HTTPS
            GIT_REMOTE_URL=$(git config --get remote.origin.url || echo "")
            if [[ "$GIT_REMOTE_URL" == *"git@"* ]]; then
              echo "ğŸ” Git remote uses SSH, checking if we can use HTTPS instead..."
              # ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ HTTPS ĞµÑĞ»Ğ¸ SSH Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚
              GIT_REPO_NAME=$(echo "$GIT_REMOTE_URL" | sed -E 's/.*[:/]([^/]+\/[^/]+)(\.git)?$/\1/' | sed 's/\.git$//')
              if [ -n "$GIT_REPO_NAME" ]; then
                echo "ğŸ’¡ Alternative: git remote set-url origin https://github.com/$GIT_REPO_NAME.git"
                # ĞĞµ Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸, Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´Ğ°ĞµĞ¼
              fi
            fi
            
            # ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ fetch Ñ Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚Ğ¾Ğ¼ Ğ¸ retry
            MAX_RETRIES=3
            RETRY_COUNT=0
            FETCH_SUCCESS=false
            
            # ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼ DNS Ñ‡ĞµÑ€ĞµĞ· systemd-resolved
            echo "ğŸ”§ Configuring DNS via systemd-resolved..."
            if command -v resolvectl >/dev/null 2>&1; then
              # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ¼Ñ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ°
              INTERFACE=$(ip route | grep default | awk '{print $5}' | head -1 || echo "eth0")
              echo "ğŸ“¡ Using interface: $INTERFACE"
              
              # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ DNS ÑĞµÑ€Ğ²ĞµÑ€Ñ‹
              resolvectl dns "$INTERFACE" 8.8.8.8 8.8.4.4 2>/dev/null || true
              
              # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ DNS ĞºĞµÑˆ
              echo "ğŸ”„ Flushing DNS cache..."
              resolvectl flush-caches 2>/dev/null || true
            fi
            
            # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ GitHub Ğ² /etc/hosts Ğ´Ğ»Ñ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ğ¸
            echo "ğŸ“ Adding GitHub to /etc/hosts..."
            if ! grep -q "github.com" /etc/hosts 2>/dev/null; then
              GITHUB_IPS="140.82.121.3 140.82.121.4"
              for IP in $GITHUB_IPS; do
                if ping -c 1 -W 2 "$IP" >/dev/null 2>&1; then
                  echo "$IP github.com" | sudo tee -a /etc/hosts >/dev/null 2>&1 || true
                  echo "âœ… Added $IP -> github.com to /etc/hosts"
                  break
                fi
              done
            else
              echo "âœ… GitHub already in /etc/hosts"
            fi
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€ĞµĞ·Ğ¾Ğ»Ğ²Ğ¸Ğ½Ğ³
            echo "ğŸ” Testing DNS resolution..."
            if getent hosts github.com >/dev/null 2>&1; then
              echo "âœ… github.com resolves to: $(getent hosts github.com | awk '{print $1}')"
            else
              echo "âš ï¸ Warning: github.com DNS resolution failed"
            fi
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "ğŸ”„ Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: Fetching from origin/main..."
              
              # ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ fetch Ñ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¼ Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚Ğ¾Ğ¼
              if timeout 60 git fetch origin main 2>&1; then
                FETCH_SUCCESS=true
                break
              else
                FETCH_EXIT_CODE=$?
                echo "âš ï¸ Fetch attempt failed with exit code: $FETCH_EXIT_CODE"
                
                # Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ SSH ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ñ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ¾Ğ¿Ñ†Ğ¸ÑĞ¼Ğ¸
                if [[ "$GIT_REMOTE_URL" == *"git@"* ]]; then
                  echo "ğŸ’¡ Retrying with SSH options..."
                  GIT_SSH_COMMAND="ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
                  timeout 60 git fetch origin main 2>&1 || true
                fi
                
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "â³ Waiting 5 seconds before retry..."
                  sleep 5
                fi
              fi
            done
            
            if [ "$FETCH_SUCCESS" = false ]; then
              echo "âŒ Error: Failed to fetch from origin/main after $MAX_RETRIES attempts"
              echo "ğŸ” Debug info:"
              echo "  Git remote URL: $(git config --get remote.origin.url || echo 'not set')"
              echo "  Current branch: $(git branch --show-current || echo 'unknown')"
              echo "  Last commit: $(git log -1 --oneline || echo 'unknown')"
              echo ""
              echo "ğŸ’¡ Trying alternative: pull directly..."
              if timeout 30 git pull origin main 2>&1; then
                echo "âœ… Pull succeeded as fallback"
              else
                echo "âŒ Pull also failed - this is a network/DNS issue on the server"
                echo "ğŸ’¡ Solutions:"
                echo "  1. Check DNS settings on server: /etc/resolv.conf"
                echo "  2. Try: echo 'nameserver 8.8.8.8' | sudo tee -a /etc/resolv.conf"
                echo "  3. Or wait for network to recover"
                echo "  4. Or deploy manually via rsync from GitHub Actions"
                exit 1
              fi
            else
              echo "âœ… Fetch succeeded"
              echo "ğŸ”„ Resetting to origin/main..."
              git reset --hard origin/main || {
                echo "âŒ Error: Failed to reset to origin/main"
                exit 1
              }
            fi
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ nvm Ğ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµĞ¼ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ
            if [ -s "$HOME/.nvm/nvm.sh" ]; then
              echo "ğŸ“¦ Loading nvm..."
              source "$HOME/.nvm/nvm.sh"
              nvm use 20 || nvm use default || true
            fi
            
            # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
            echo "ğŸ“¦ Installing dependencies..."
            npm ci || {
              echo "âŒ Error: npm ci failed"
              exit 1
            }
            
            # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚
            echo "ğŸ”¨ Building Next.js application..."
            # Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸ Ğ´Ğ»Ñ Node.js (6GB Ğ´Ğ»Ñ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ğ¸)
            export NODE_OPTIONS="--max-old-space-size=6144"
            # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ĞºĞµÑˆ Next.js Ğ¿ĞµÑ€ĞµĞ´ ÑĞ±Ğ¾Ñ€ĞºĞ¾Ğ¹
            rm -rf .next || true
            npm run build || {
              echo "âŒ Error: Build failed"
              exit 1
            }
            
            # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ PM2 Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ
            echo "ğŸ”„ Restarting/Starting PM2 process..."
            if command -v pm2 >/dev/null 2>&1; then
              if pm2 describe "$PM2_APP_NAME" >/dev/null 2>&1; then
                pm2 restart "$PM2_APP_NAME" && echo "âœ… PM2 process '$PM2_APP_NAME' restarted"
              else
                echo "Process '$PM2_APP_NAME' not found, cleaning and starting..."
                pm2 delete "$PM2_APP_NAME" 2>/dev/null || true
                pm2 delete "theame-next" 2>/dev/null || true
                pm2 start ecosystem.config.js
                echo "âœ… PM2 process started"
              fi
              pm2 save || true
            else
              echo "âŒ Error: PM2 is not installed or not in PATH"
              echo "ğŸ’¡ Hint: Install PM2 with: npm install -g pm2"
              echo "ğŸ’¡ Hint: Then start the app with: pm2 start ecosystem.config.js"
              exit 1
            fi
            
            echo "âœ… Deployment completed successfully!"

name: Deploy to server

on:
  push:
    branches: ["main"]

# –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –¥–µ–ø–ª–æ–µ–≤
concurrency:
  group: deploy
  cancel-in-progress: false

env:
  SITE_URL: https://theame.ru
  NEXT_PUBLIC_SITE_URL: https://theame.ru

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          envs: SITE_URL,NEXT_PUBLIC_SITE_URL
          command_timeout: 30m
          script: |
            set -euo pipefail
            
            DEPLOY_PATH="${DEPLOY_PATH:-/var/www/theame}"
            PM2_APP_NAME="${PM2_APP_NAME:-theame-next}"
            
            echo "üöÄ Starting deployment..."
            echo "üìÅ Deploy path: $DEPLOY_PATH"
            echo "üîÑ PM2 app name: $PM2_APP_NAME"
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd "$DEPLOY_PATH" || {
              echo "‚ùå Error: Directory $DEPLOY_PATH does not exist"
              exit 1
            }
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
            echo "üì• Fetching latest code..."
            
            # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º DNS –¥–ª—è systemd-resolved (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            echo "üîß Configuring DNS..."
            if command -v resolvectl >/dev/null 2>&1; then
              echo "üìã Current DNS status:"
              resolvectl status || true
              echo "üîß Setting DNS servers..."
              resolvectl dns eth0 8.8.8.8 8.8.4.4 2>/dev/null || resolvectl dns $(ip route | grep default | awk '{print $5}' | head -1) 8.8.8.8 8.8.4.4 2>/dev/null || true
            fi
            
            # –û–±–Ω–æ–≤–ª—è–µ–º /etc/resolv.conf –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
            if [ -L /etc/resolv.conf ]; then
              echo "üìù /etc/resolv.conf is a symlink, checking systemd-resolved..."
            else
              echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf.tmp >/dev/null 2>&1 || true
              echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf.tmp >/dev/null 2>&1 || true
            fi
            
            # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º git remote
            echo "üîç Checking git remote configuration..."
            git remote -v || echo "‚ö†Ô∏è Warning: git remote check failed"
            
            # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å GitHub
            echo "üîç Testing GitHub connectivity..."
            if ping -c 1 github.com >/dev/null 2>&1 || ping -c 1 140.82.121.3 >/dev/null 2>&1; then
              echo "‚úÖ GitHub is reachable"
            else
              echo "‚ö†Ô∏è Warning: GitHub ping failed, but continuing..."
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º git remote URL –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–∞ HTTPS
            GIT_REMOTE_URL=$(git config --get remote.origin.url || echo "")
            if [[ "$GIT_REMOTE_URL" == *"git@"* ]]; then
              echo "üîç Git remote uses SSH, checking if we can use HTTPS instead..."
              # –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS –µ—Å–ª–∏ SSH –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
              GIT_REPO_NAME=$(echo "$GIT_REMOTE_URL" | sed -E 's/.*[:/]([^/]+\/[^/]+)(\.git)?$/\1/' | sed 's/\.git$//')
              if [ -n "$GIT_REPO_NAME" ]; then
                echo "üí° Alternative: git remote set-url origin https://github.com/$GIT_REPO_NAME.git"
                # –ù–µ –º–µ–Ω—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º
              fi
            fi
            
            # –ü—Ä–æ–±—É–µ–º fetch —Å —Ç–∞–π–º–∞—É—Ç–æ–º –∏ retry
            MAX_RETRIES=3
            RETRY_COUNT=0
            FETCH_SUCCESS=false
            
            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º DNS —á–µ—Ä–µ–∑ systemd-resolved
            echo "üîß Configuring DNS via systemd-resolved..."
            if command -v resolvectl >/dev/null 2>&1; then
              # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
              INTERFACE=$(ip route | grep default | awk '{print $5}' | head -1 || echo "eth0")
              echo "üì° Using interface: $INTERFACE"
              
              # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º DNS —Å–µ—Ä–≤–µ—Ä—ã
              resolvectl dns "$INTERFACE" 8.8.8.8 8.8.4.4 2>/dev/null || true
              
              # –û—á–∏—â–∞–µ–º DNS –∫–µ—à
              echo "üîÑ Flushing DNS cache..."
              resolvectl flush-caches 2>/dev/null || true
            fi
            
            # –î–æ–±–∞–≤–ª—è–µ–º GitHub –≤ /etc/hosts –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            echo "üìù Adding GitHub to /etc/hosts..."
            if ! grep -q "github.com" /etc/hosts 2>/dev/null; then
              GITHUB_IPS="140.82.121.3 140.82.121.4"
              for IP in $GITHUB_IPS; do
                if ping -c 1 -W 2 "$IP" >/dev/null 2>&1; then
                  echo "$IP github.com" | sudo tee -a /etc/hosts >/dev/null 2>&1 || true
                  echo "‚úÖ Added $IP -> github.com to /etc/hosts"
                  break
                fi
              done
            else
              echo "‚úÖ GitHub already in /etc/hosts"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑–æ–ª–≤–∏–Ω–≥
            echo "üîç Testing DNS resolution..."
            if getent hosts github.com >/dev/null 2>&1; then
              echo "‚úÖ github.com resolves to: $(getent hosts github.com | awk '{print $1}')"
            else
              echo "‚ö†Ô∏è Warning: github.com DNS resolution failed"
            fi
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "üîÑ Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: Fetching from origin/main..."
              
              # –ü—Ä–æ–±—É–µ–º fetch —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º
              if timeout 60 git fetch origin main 2>&1; then
                FETCH_SUCCESS=true
                break
              else
                FETCH_EXIT_CODE=$?
                echo "‚ö†Ô∏è Fetch attempt failed with exit code: $FETCH_EXIT_CODE"
                
                # –ï—Å–ª–∏ —ç—Ç–æ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –ø—Ä–æ–±—É–µ–º —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –æ–ø—Ü–∏—è–º–∏
                if [[ "$GIT_REMOTE_URL" == *"git@"* ]]; then
                  echo "üí° Retrying with SSH options..."
                  GIT_SSH_COMMAND="ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
                  timeout 60 git fetch origin main 2>&1 || true
                fi
                
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "‚è≥ Waiting 5 seconds before retry..."
                  sleep 5
                fi
              fi
            done
            
            if [ "$FETCH_SUCCESS" = false ]; then
              echo "‚ùå Error: Failed to fetch from origin/main after $MAX_RETRIES attempts"
              echo "üîç Debug info:"
              echo "  Git remote URL: $(git config --get remote.origin.url || echo 'not set')"
              echo "  Current branch: $(git branch --show-current || echo 'unknown')"
              echo "  Last commit: $(git log -1 --oneline || echo 'unknown')"
              echo ""
              echo "üí° Trying alternative: pull directly..."
              if timeout 30 git pull origin main 2>&1; then
                echo "‚úÖ Pull succeeded as fallback"
              else
                echo "‚ùå Pull also failed - this is a network/DNS issue on the server"
                echo "üí° Solutions:"
                echo "  1. Check DNS settings on server: /etc/resolv.conf"
                echo "  2. Try: echo 'nameserver 8.8.8.8' | sudo tee -a /etc/resolv.conf"
                echo "  3. Or wait for network to recover"
                echo "  4. Or deploy manually via rsync from GitHub Actions"
                exit 1
              fi
            else
              echo "‚úÖ Fetch succeeded"
              echo "üîÑ Resetting to origin/main..."
              git reset --hard origin/main || {
                echo "‚ùå Error: Failed to reset to origin/main"
                exit 1
              }
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ nvm –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å
            if [ -s "$HOME/.nvm/nvm.sh" ]; then
              echo "üì¶ Loading nvm..."
              source "$HOME/.nvm/nvm.sh"
              nvm use 20 || nvm use default || true
            fi
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "üì¶ Installing dependencies..."
            npm ci || {
              echo "‚ùå Error: npm ci failed"
              exit 1
            }
            
            # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
            echo "üî® Building Next.js application..."
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—É—é –ø–∞–º—è—Ç—å
            echo "üíæ System memory info:"
            free -h || true
            echo ""
            
            # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç –ø–∞–º—è—Ç–∏ –¥–ª—è Node.js (4GB, –∞–¥–∞–ø—Ç–∏–≤–Ω–æ –ø–æ–¥ –¥–æ—Å—Ç—É–ø–Ω—É—é –ø–∞–º—è—Ç—å)
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—É—é –ø–∞–º—è—Ç—å –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–∏–º–∏—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ
            AVAILABLE_MEM=$(free -m | awk '/^Mem:/{print $7}' || echo "4096")
            TOTAL_MEM=$(free -m | awk '/^Mem:/{print $2}' || echo "4096")
            
            echo "üíæ Total RAM: ${TOTAL_MEM}MB"
            echo "üíæ Available RAM: ${AVAILABLE_MEM}MB"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º swap
            SWAP_TOTAL=$(free -m | awk '/^Swap:/{print $2}' || echo "0")
            SWAP_USED=$(free -m | awk '/^Swap:/{print $3}' || echo "0")
            if [ "$SWAP_TOTAL" -gt 0 ]; then
              echo "üíæ Swap: ${SWAP_TOTAL}MB total, ${SWAP_USED}MB used"
            fi
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–∏–º–∏—Ç –ø–∞–º—è—Ç–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–π –ø–∞–º—è—Ç–∏
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –º–∞–ª–æ–º–æ—â–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
            if [ "$AVAILABLE_MEM" -lt 512 ]; then
              # –û—á–µ–Ω—å –º–∞–ª–æ –ø–∞–º—è—Ç–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∏–Ω–∏–º—É–º
              NODE_MEM_LIMIT=1024
              echo "‚ö†Ô∏è  Very low memory detected (${AVAILABLE_MEM}MB available), using 1GB limit"
              echo "üí° Consider upgrading server RAM or adding more swap"
            elif [ "$AVAILABLE_MEM" -lt 1024 ]; then
              # –ú–∞–ª–æ –ø–∞–º—è—Ç–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º 1.5GB
              NODE_MEM_LIMIT=1536
              echo "‚ö†Ô∏è  Low memory detected (${AVAILABLE_MEM}MB available), using 1.5GB limit"
            elif [ "$AVAILABLE_MEM" -lt 2048 ]; then
              # –°—Ä–µ–¥–Ω—è—è –ø–∞–º—è—Ç—å - –∏—Å–ø–æ–ª—å–∑—É–µ–º 2GB
              NODE_MEM_LIMIT=2048
              echo "‚ÑπÔ∏è  Medium memory detected (${AVAILABLE_MEM}MB available), using 2GB limit"
            elif [ "$AVAILABLE_MEM" -lt 4096 ]; then
              # –•–æ—Ä–æ—à–∞—è –ø–∞–º—è—Ç—å - –∏—Å–ø–æ–ª—å–∑—É–µ–º 3GB
              NODE_MEM_LIMIT=3072
              echo "‚úÖ Good memory detected (${AVAILABLE_MEM}MB available), using 3GB limit"
            else
              # –û—Ç–ª–∏—á–Ω–∞—è –ø–∞–º—è—Ç—å - –∏—Å–ø–æ–ª—å–∑—É–µ–º 4GB
              NODE_MEM_LIMIT=4096
              echo "‚úÖ Sufficient memory detected (${AVAILABLE_MEM}MB available), using 4GB limit"
            fi
            
            export NODE_OPTIONS="--max-old-space-size=${NODE_MEM_LIMIT}"
            echo "üìä NODE_OPTIONS set to: $NODE_OPTIONS"
            
            # –û—á–∏—â–∞–µ–º –∫–µ—à Next.js –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π
            echo "üßπ Cleaning Next.js cache..."
            rm -rf .next || true
            
            # –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ webpack –≤–º–µ—Å—Ç–æ Turbopack
            echo "üî® Starting build with webpack..."
            echo "üìä Using NODE_OPTIONS: --max-old-space-size=${NODE_MEM_LIMIT}"
            
            # –û—á–∏—â–∞–µ–º –∫–µ—à npm –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏
            echo "üßπ Cleaning npm cache..."
            npm cache clean --force || true
            
            # –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∏–ø–æ–≤ TypeScript –≤–æ –≤—Ä–µ–º—è —Å–±–æ—Ä–∫–∏ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
            # TypeScript –ø—Ä–æ–≤–µ—Ä–∫–∞ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
            export SKIP_ENV_VALIDATION=true
            export NEXT_TELEMETRY_DISABLED=1
            
            # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ NODE_OPTIONS –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ npm run build
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–∞–ª–æ–º–æ—â–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
            if [ "$AVAILABLE_MEM" -lt 1024 ]; then
              echo "‚ö†Ô∏è  Low memory server detected - using minimal build settings"
              # –î–ª—è –º–∞–ª–æ–º–æ—â–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–Ω—å—à–µ –≤–æ—Ä–∫–µ—Ä–æ–≤ –∏ –æ—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∏–ø–æ–≤
              NODE_OPTIONS="--max-old-space-size=${NODE_MEM_LIMIT}" TYPESCRIPT_CHECK=false npm run build -- --webpack || {
                echo "‚ùå Error: Build failed on low-memory server"
                echo ""
                echo "üìä Memory diagnostics:"
                free -h || true
                echo ""
                echo "üí° Troubleshooting for low-memory servers:"
                echo "   1. Upgrade server RAM to at least 2GB (recommended: 4GB+)"
                echo "   2. Increase swap space: sudo fallocate -l 4G /swapfile && sudo chmod 600 /swapfile && sudo mkswap /swapfile && sudo swapon /swapfile"
                echo "   3. Free up memory: stop unnecessary services, clear caches"
                echo "   4. Consider building locally and deploying pre-built files"
                exit 1
              }
            else
              # –î–ª—è —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç—å—é —Ç–æ–∂–µ –æ—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∏–ø–æ–≤ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
              NODE_OPTIONS="--max-old-space-size=${NODE_MEM_LIMIT}" SKIP_TYPES_CHECK=true npm run build -- --webpack || {
                echo "‚ùå Error: Build failed"
                echo ""
                echo "üìä Memory diagnostics:"
                free -h || true
                echo ""
                echo "üí° Troubleshooting:"
                echo "   1. Check if server has enough RAM (recommended: 4GB+)"
                echo "   2. Check if swap is enabled: swapon --show"
                echo "   3. Check build logs above for OOM (Out of Memory) errors"
                echo "   4. Try increasing NODE_MEM_LIMIT or adding swap space"
                exit 1
              }
            fi
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∏–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å
            echo "üîÑ Restarting/Starting PM2 process..."
            if command -v pm2 >/dev/null 2>&1; then
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã PM2
              echo "üìã Current PM2 processes:"
              pm2 list || true
              echo ""
              
              if pm2 describe "$PM2_APP_NAME" >/dev/null 2>&1; then
                echo "üîÑ Restarting existing process '$PM2_APP_NAME'..."
                pm2 restart "$PM2_APP_NAME" || {
                  echo "‚ö†Ô∏è  Restart failed, trying to delete and start fresh..."
                  pm2 delete "$PM2_APP_NAME" 2>/dev/null || true
                  pm2 start ecosystem.config.cjs || {
                    echo "‚ùå Failed to start PM2 process"
                    exit 1
                  }
                }
                echo "‚úÖ PM2 process '$PM2_APP_NAME' restarted"
              else
                echo "Process '$PM2_APP_NAME' not found, cleaning old processes and starting..."
                pm2 delete "$PM2_APP_NAME" 2>/dev/null || true
                pm2 delete "nextjs-project" 2>/dev/null || true
                pm2 delete "theame" 2>/dev/null || true
                pm2 delete "theame-next" 2>/dev/null || true
                
                echo "üöÄ Starting PM2 process from ecosystem.config.cjs..."
                pm2 start ecosystem.config.cjs || {
                  echo "‚ùå Failed to start PM2 process"
                  echo "üí° Check if ecosystem.config.cjs exists and is valid"
                  exit 1
                }
                echo "‚úÖ PM2 process started"
              fi
              
              # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é PM2
              pm2 save || true
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞
              echo ""
              echo "üìä PM2 status after restart:"
              pm2 status "$PM2_APP_NAME" || pm2 list
              
              # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω
              sleep 5
              if pm2 describe "$PM2_APP_NAME" >/dev/null 2>&1; then
                STATUS=$(pm2 jlist 2>/dev/null | grep -o "\"name\":\"$PM2_APP_NAME\".*\"pm_id\":[0-9]*" | grep -o "\"status\":\"[^\"]*\"" | cut -d'"' -f4 || echo "unknown")
                echo "‚úÖ Process '$PM2_APP_NAME' is running (status: ${STATUS})"
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç
                echo "üîç Checking if application is responding..."
                sleep 2
                if curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 > /dev/null 2>&1; then
                  HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000)
                  echo "‚úÖ Application is responding on localhost:3000 (HTTP $HTTP_CODE)"
                else
                  echo "‚ö†Ô∏è  Warning: Application is not responding on localhost:3000"
                  echo "üìã Recent PM2 logs:"
                  pm2 logs "$PM2_APP_NAME" --lines 20 --nostream || true
                fi
              else
                echo "‚ö†Ô∏è  Warning: Process '$PM2_APP_NAME' may not be running properly"
                pm2 list
                echo ""
                echo "üìã Recent PM2 error logs:"
                pm2 logs "$PM2_APP_NAME" --err --lines 30 --nostream || true
              fi
            else
              echo "‚ùå Error: PM2 is not installed or not in PATH"
              echo "üí° Hint: Install PM2 with: npm install -g pm2"
              echo "üí° Hint: Then start the app with: pm2 start ecosystem.config.cjs"
              exit 1
            fi
            
            echo "‚úÖ Deployment completed successfully!"
